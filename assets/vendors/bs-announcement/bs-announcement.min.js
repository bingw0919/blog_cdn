(()=>{class AnnouncementSystem{constructor(){this.root=document.getElementById('announcement-root');if(!this.root)return;try{this.settings=JSON.parse(this.root.dataset.settings);this.announcements=JSON.parse(this.root.dataset.announcements);this.state=this.loadState();this.initDOM();this.bindEvents();this.checkVisibility();}catch(error){console.error('公告组件初始化失败:',error);}}initDOM(){this.cleanup();this.box=document.createElement('div');this.box.className=`announcement-box${this.state.minimized?' minimized':''}`;const header=document.createElement('div');header.className='ann-header';header.innerHTML=`<span>${this.settings.popupTitle}</span><div class="ann-controls"><button class="min-btn">−</button><button class="close-btn">×</button></div>`;this.box.appendChild(header);const content=document.createElement('div');content.className='ann-content';this.announcements.forEach((item,index)=>{const div=document.createElement('div');div.className='ann-item';div.innerHTML=`<div class="ann-item-title">${this.safeHTML2(item.Popup_Title_Value)}</div><div class="ann-item-content">${this.safeHTML(item.Popup_Content_Value)}</div>`;content.appendChild(div);});this.box.appendChild(content);this.dialog=document.createElement('div');this.dialog.className='ann-dialog';this.dialog.innerHTML=`<h3 style="margin:0 0 15px 0; font-size:17px;">关闭公告</h3><div class="ann-option"><input type="radio"id="ann-week"name="ann-close"value="week"required><label for="ann-week">一周内不再显示</label></div><div class="ann-option"><input type="radio"id="ann-month"name="ann-close"value="month"><label for="ann-month">一月内不再显示</label></div><div class="ann-option"><input type="radio"id="ann-halfYear"name="ann-close"value="halfYear"><label for="ann-halfYear">半年内不再显示</label></div><div class="ann-buttons"><button class="ann-btn cancel"type="button">取消</button><button class="ann-btn confirm">确认关闭</button></div>`;this.box.appendChild(this.dialog);this.root.appendChild(this.box);if(!this.state.minimized&&this.announcements.length>0){this.toggleItem(this.state.activeIndex||0);}}safeHTML(str){const div=document.createElement('div');div.innerHTML=str;return div.innerHTML;}safeHTML2(str){const div=document.createElement('div');div.textContent=str;return div.innerHTML;}bindEvents(){this.unbindEvents();this.box.querySelector('.min-btn').addEventListener('click',e=>this.toggleMinimize(e));this.box.querySelector('.close-btn').addEventListener('click',e=>this.showDialog(e));this.box.querySelectorAll('.ann-item-title').forEach((title,index)=>{title.addEventListener('click',()=>this.toggleItem(index));});this.box.querySelector('.cancel').addEventListener('click',()=>this.hideDialog());this.box.querySelector('.confirm').addEventListener('click',()=>this.handleClose());this.handleOutsideClickBound=this.handleOutsideClick.bind(this);document.addEventListener('click',this.handleOutsideClickBound);}toggleMinimize(e){e.stopPropagation();this.state.minimized=!this.state.minimized;this.box.classList.toggle('minimized');this.saveState();}toggleItem(index){if(this.state.minimized)return;this.box.querySelectorAll('.ann-item-content').forEach((content,i)=>{content.classList.toggle('active',i===index);});this.state.activeIndex=index;this.saveState();}showDialog(e){e.stopPropagation();this.dialog.style.display='block';const viewportHeight=window.innerHeight;const dialogHeight=this.dialog.offsetHeight;const centerY=Math.max(100,viewportHeight/2-dialogHeight/2);this.dialog.style.bottom=`${centerY}px`;this.dialog.setAttribute('data-show','');}hideDialog(){this.dialog.removeAttribute('data-show');setTimeout(()=>{this.dialog.style.display='none';},300);}handleClose(){const selected=this.dialog.querySelector('input:checked');if(!selected)return alert('请选择关闭时长');const durations={week:6048e5,month:2592e6,halfYear:15552e6};this.state.closedUntil=Date.now()+durations[selected.value];this.saveState();this.box.style.display='none';this.hideDialog();}handleOutsideClick(e){if(!this.box.contains(e.target)){this.hideDialog();}}checkVisibility(){if(this.state.closedUntil&&Date.now()<this.state.closedUntil){this.box.style.display='none';}else{this.box.style.display='block';}}loadState(){try{const saved=localStorage.getItem(this.settings.storageKey);return saved?JSON.parse(saved):{minimized:false,activeIndex:0,closedUntil:0};}catch{return this.getDefaultState();}}getDefaultState(){return{minimized:false,activeIndex:0,closedUntil:0};}saveState(){localStorage.setItem(this.settings.storageKey,JSON.stringify(this.state));}unbindEvents(){if(this.handleOutsideClick){document.removeEventListener('click',this.handleOutsideClick);}}cleanup(){if(this.box&&this.box.parentNode){this.box.parentNode.removeChild(this.box);}this.unbindEvents();}destroy(){if(this.handleOutsideClickBound){document.removeEventListener('click',this.handleOutsideClickBound);}this.cleanup();this.root.innerHTML='';}}let annInstance=null;const initAnnouncement=()=>{try{if(annInstance){annInstance.destroy();annInstance=null;}if(document.getElementById('announcement-root')){annInstance=new AnnouncementSystem();}}catch(error){console.error('公告初始化失败:',error);}};const handleReady=()=>{if(document.readyState==='complete'){initAnnouncement();}else{document.addEventListener('DOMContentLoaded',initAnnouncement);}};const handleUnload=()=>{if(annInstance){annInstance.destroy();annInstance=null;}};handleReady();document.addEventListener('pjax:complete',initAnnouncement);window.addEventListener('beforeunload',handleUnload);window.addEventListener('pagehide',handleUnload);})();